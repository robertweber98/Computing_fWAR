---
title: "Computation"
author: "Rob Weber"
date: "July 24, 2018"
output: html_document
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Library}
library(tidyverse)
library(ggplot2)
library(baseballr)
```

# Data
The in-file data-set names are as follows: "wp.df" is the full (with pitchers) fangraphs.com batting data set, "sc.data" is the 2017 statcast data, "team_stats" is the 2017 team data, "id" is the mlb id data set, and "defense" is the fangraphs.com data set with the fielding data.

# Cleaning
Some cleaing is necessary before the process begins. First, we need the positions of all the players in the data set because fangraphs.com doesn't let positions be in a dataset with offensive stats for some reason. That is what the "defense" data is used for. Then, since this is WAR for position players, fangraphs.com eliminates any pitchers from the data set in their calculations, but I keep the other data set just in case. Lastly, some of the names don't match up with the names in the data set being used to match names to their respective player i.d.s in the statcast data set. 
```{r Cleaning}
# first, this narrows down "defense" to just the player name, team, position, 
## and innings played at said position (it is needed for the positional adjustment later)
defense[ , c("Name", "Team", "Position", "Inn")] -> defense 
# this next step switches the team abbreviations in "defense" to the team names like in "wp.df"
defense <- defense %>%
  mutate(Team = ifelse(Team == "ARI", "Diamondbacks", 
                    ifelse(Team == "ATL", "Braves", 
                    ifelse(Team == "BAL", "Orioles", 
                    ifelse(Team == "BOS", "Red Sox", 
                    ifelse(Team == "CHC", "Cubs", 
                    ifelse(Team == "CIN", "Reds", 
                    ifelse(Team == "CLE", "Indians", 
                    ifelse(Team == "COL", "Rockies", 
                    ifelse(Team == "CHW", "White Sox", 
                    ifelse(Team == "DET", "Tigers", 
                    ifelse(Team == "HOU", "Astros", 
                    ifelse(Team == "KCR", "Royals", 
                    ifelse(Team == "LAA", "Angels", 
                    ifelse(Team == "LAD", "Dodgers", 
                    ifelse(Team == "MIA", "Marlins", 
                    ifelse(Team == "MIL", "Brewers", 
                    ifelse(Team == "MIN", "Twins", 
                    ifelse(Team == "NYM", "Mets", 
                    ifelse(Team == "NYY", "Yankees", 
                    ifelse(Team == "OAK", "Athletics", 
                    ifelse(Team == "PHI", "Phillies", 
                    ifelse(Team == "PIT", "Pirates", 
                    ifelse(Team == "SDP", "Padres", 
                    ifelse(Team == "SEA", "Mariners", 
                    ifelse(Team == "SFG", "Giants", 
                    ifelse(Team == "STL", "Cardinals", 
                    ifelse(Team == "TBR", "Rays", 
                    ifelse(Team == "TEX", "Rangers", 
                    ifelse(Team == "TOR", "Blue Jays", 
                    ifelse(Team == "WSN", "Nationals", 
                           "null")))))))))))))))))))))))))))))))
as.character(wp.df$Name) -> wp.df$Name; as.character(defense$Name) -> defense$Name # just makes sure the name columns are treated as characters
# this is to solve a headache produced by the fact that a player is in "defense" 
## with data from every time they played a different position. What fangraphs does in terms of the 
## positional adjustment for this is not stated. So, I just take the position they played the most innings and 
## total the number of innings played at all positions.
defense <- defense %>%
  group_by(Name, Team) %>%
  summarise(Position = Position[Inn == max(Inn)], 
            Inn = sum(Inn))
left_join(wp.df, defense, by = c("Name", "Team")) -> wp.df # just gets the dfs together
# this step gets rid of the pitchers from the data set and creates a new df calle "full.df" This is what will be used from now on
wp.df[which(wp.df$Position != "P"), ] -> full.df

str_replace_all(full.df$Name, "Nick Delmonico", "Nicky Delmonico") -> full.df$Name
str_replace_all(full.df$Name, "Nicholas Castellanos", "Nick Castellanos") -> full.df$Name
str_replace_all(full.df$Name, "Eric Young", "Eric Young Jr.") -> full.df$Name
str_replace_all(full.df$Name, "Raffy Lopez", "Rafael Lopez") -> full.df$Name
str_replace_all(full.df$Name, "Yolmer Sanchez", "Carlos Sanchez") -> full.df$Name
str_replace_all(full.df$Name, "Rickie Weeks Jr.", "Rickie Weeks") -> full.df$Name
str_replace_all(full.df$Name, "Zack Granite", "Zach Granite") -> full.df$Name
str_replace_all(full.df$Name, "Hyun Soo Kim", "Hyun-soo Kim") -> full.df$Name
str_replace_all(full.df$Name, "Rey Fuentes", "Reymond Fuentes") -> full.df$Name
str_replace_all(full.df$Name, "Vince Velasquez", "Vincent Velasquez") -> full.df$Name
str_replace_all(full.df$Name, "Cam Perkins", "Cameron Perkins") -> full.df$Name
str_replace_all(full.df$Name, "Adalberto Mondesi", "Raul Mondesi") -> full.df$Name
str_replace_all(full.df$Name, "Luke Sims", "Lucas Sims") -> full.df$Name
str_replace_all(full.df$Name, "Rubby de la Rosa", "Rubby De La Rosa") -> full.df$Name
str_replace_all(full.df$Name, "AJ Ramos", "A.J. Ramos") -> full.df$Name
str_replace_all(full.df$Name, "T.J. House", "TJ House") -> full.df$Name
str_replace_all(full.df$Name, "Felipe Vasquez", "Felipe Rivero") -> full.df$Name
str_replace_all(full.df$Name, "Dan Winkler", "Daniel Winkler") -> full.df$Name
str_replace_all(full.df$Name, "Jakob Junis", "Jake Junis") -> full.df$Name
str_replace_all(full.df$Name, "Jake Faria", "Jacob Faria") -> full.df$Name
str_replace_all(full.df$Name, "Matt Strahm", "Matthew Strahm") -> full.df$Name
str_replace_all(full.df$Name, "Lance McCullers Jr.", "Lance McCullers") -> full.df$Name
id[-c(which(id$mlb_id == 446345)), ] -> id
```

# Batting Runs
- $Bat = wRAA + (lgR/PA - (PF*lgR/PA))*PA + (lgR/PA - (AL or NL non-pitcher wRC/PA))*PA$
- $wRAA = ((wOBA - lgwOBA)/wOBA Scale) * PA$
- $wOBA = (weight*uBB + weight*HBP + weight*1B + weight*2B + weight*3B + weight*HR) / (AB + uBB + SF + HBP)$
```{r Batting Runs}
# wOBA first
# This uses baseballr functions to get the linear weights and then stores it
run_expectancy_code(sc.data) -> weights
linear_weights_savant(weights) -> weights

# want to rename the fangraphs wOBA so it can be differentiated later
full.df <- full.df %>%
  rename(wOBA_fg = wOBA) %>%
  mutate(uBB = BB - IBB) # get unintentional walks too
# this gets wOBA not scaled to OBP
(((weights$linear_weights_above_outs[weights$events == "walk"] * full.df$uBB) +
 (weights$linear_weights_above_outs[weights$events == "hit_by_pitch"] * full.df$HBP) +
 (weights$linear_weights_above_outs[weights$events == "single"] * full.df$X1B) +
 (weights$linear_weights_above_outs[weights$events == "double"] * full.df$X2B) +
 (weights$linear_weights_above_outs[weights$events == "triple"] * full.df$X3B) +
 (weights$linear_weights_above_outs[weights$events == "home_run"] * full.df$HR)) 
  / (full.df$AB + full.df$uBB + full.df$SF + full.df$HBP)) -> full.df$wOBA_unscaled 

# now to get the weights scaled to OBP
# need the mean of both OBP and unscaled wOBA
mean(full.df$OBP, na.rm = T) -> obp_mean 
mean(full.df$wOBA_unscaled, na.rm = T) -> woba_unscaled_mean 
# this gets the wOBA scale
obp_mean / woba_unscaled_mean -> woba_scale

# gets the scaled weights
weights$linear_weights_above_outs * woba_scale -> weights$linear_weights_scaled

# get scaled wOBA
(((weights$linear_weights_scaled[weights$events == "walk"] * full.df$uBB) +
 (weights$linear_weights_scaled[weights$events == "hit_by_pitch"] * full.df$HBP) +
 (weights$linear_weights_scaled[weights$events == "single"] * full.df$X1B) +
 (weights$linear_weights_scaled[weights$events == "double"] * full.df$X2B) +
 (weights$linear_weights_scaled[weights$events == "triple"] * full.df$X3B) +
 (weights$linear_weights_scaled[weights$events == "home_run"] * full.df$HR)) / (full.df$AB + full.df$uBB + full.df$SF + full.df$HBP))-> full.df$wOBA_x

# wRAA next
```

